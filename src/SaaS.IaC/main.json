{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.5.6.12127",
      "templateHash": "461080599915900103"
    }
  },
  "parameters": {
    "adminApiScopes": {
      "type": "string",
      "metadata": {
        "description": "Scopes to authorize user for the admin service."
      }
    },
    "azureAdB2cAdminApiClientIdSecretValue": {
      "type": "string",
      "metadata": {
        "description": "The value of the Azure AD B2C Admin Api Client Id Key Vault Secret."
      }
    },
    "azureAdB2cDomainSecretValue": {
      "type": "string",
      "metadata": {
        "description": "The value of the Azure AD B2C Domain Key Vault Secret."
      }
    },
    "azureAdB2cInstanceSecretValue": {
      "type": "string",
      "metadata": {
        "description": "The value of the Azure AD B2C Instance Key Vault Secret."
      }
    },
    "azureAdB2cSignupAdminClientIdSecretValue": {
      "type": "string",
      "metadata": {
        "description": "The value of the Azure AD B2C Signup Admin Client Id Key Vault Secret."
      }
    },
    "azureAdB2cSignupAdminClientSecretSecretValue": {
      "type": "string",
      "metadata": {
        "description": "The value of the Azure AD B2C Signup Admin Client Secret Key Vault Secret."
      }
    },
    "azureAdB2cTenantIdSecretValue": {
      "type": "string",
      "metadata": {
        "description": "The value of the Azure AD B2C Tenant Id Key Vault Secret."
      }
    },
    "azureAdUserID": {
      "type": "string",
      "metadata": {
        "description": "The object ID of the logged in Azure Active Directory User."
      }
    },
    "permissionsApiCertificateSecretValue": {
      "type": "string",
      "metadata": {
        "description": "The value of the Permissions Api Certificate Key Vault Secret."
      }
    },
    "permissionsApiSslThumbprintSecretValue": {
      "type": "string",
      "metadata": {
        "description": "The value of the Permissions Api SSL Thumbprint Key Vault Secret."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location for all resources."
      }
    },
    "saasProviderName": {
      "type": "string",
      "metadata": {
        "description": "The SaaS Provider name."
      }
    },
    "saasEnvironment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "prod",
        "staging",
        "dev",
        "test"
      ],
      "metadata": {
        "description": "The deployment environment (e.g. prod, dev, test)."
      }
    },
    "saasInstanceNumber": {
      "type": "string",
      "maxLength": 3,
      "minLength": 1,
      "metadata": {
        "description": "The instance number of the deployment."
      }
    },
    "sqlAdministratorLogin": {
      "type": "string",
      "metadata": {
        "description": "The SQL Server administrator login."
      }
    },
    "sqlAdministratorLoginPassword": {
      "type": "secureString",
      "metadata": {
        "description": "The SQL Server administrator login password."
      }
    }
  },
  "variables": {
    "adminApiName": "[replace(format('api-admin-{0}-{1}', parameters('saasProviderName'), parameters('saasEnvironment')), '-', '')]",
    "adminSqlDatabaseName": "[format('sqldb-admin-{0}-{1}-{2}', parameters('saasProviderName'), parameters('saasEnvironment'), parameters('saasInstanceNumber'))]",
    "adminSqlServerName": "[format('sql-admin-{0}-{1}-{2}', parameters('saasProviderName'), parameters('saasEnvironment'), parameters('saasInstanceNumber'))]",
    "applicationAppServiceName": "[replace(format('app-application-{0}-{1}', parameters('saasProviderName'), parameters('saasEnvironment')), '-', '')]",
    "appServicePlanName": "[format('plan-{0}-{1}-{2}', parameters('saasProviderName'), parameters('saasEnvironment'), parameters('saasInstanceNumber'))]",
    "keyVaultName": "[format('kv-{0}-{1}-{2}', parameters('saasProviderName'), parameters('saasEnvironment'), parameters('saasInstanceNumber'))]",
    "logicAppName": "[format('logic-{0}-{1}-{2}', parameters('saasProviderName'), parameters('saasEnvironment'), parameters('saasInstanceNumber'))]",
    "permissionsApiName": "[replace(format('api-permissions-{0}-{1}', parameters('saasProviderName'), parameters('saasEnvironment')), '-', '')]",
    "permissionsSqlDatabaseName": "[format('sqldb-permissions-{0}-{1}-{2}', parameters('saasProviderName'), parameters('saasEnvironment'), parameters('saasInstanceNumber'))]",
    "permissionsSqlServerName": "[format('sql-permissions-{0}-{1}-{2}', parameters('saasProviderName'), parameters('saasEnvironment'), parameters('saasInstanceNumber'))]",
    "signupAdminAppServiceName": "[replace(format('app-signup-{0}-{1}', parameters('saasProviderName'), parameters('saasEnvironment')), '-', '')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "appServicePlanDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServicePlanName": {
            "value": "[variables('appServicePlanName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "17163284052938879433"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "The App Service Plan name."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-01-15",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "kind": "linux",
              "sku": {
                "name": "S1"
              },
              "properties": {
                "reserved": true
              }
            }
          ],
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "logicAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "logicAppName": {
            "value": "[variables('logicAppName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "1819250563407452609"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "logicAppName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Logic App."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[parameters('logicAppName')]",
              "location": "[parameters('location')]",
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {},
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "schema": {
                          "properties": {
                            "HTML": {
                              "type": "string"
                            },
                            "emailFrom": {
                              "type": "string"
                            },
                            "emailTo": {
                              "type": "string"
                            },
                            "emailToName": {
                              "type": "string"
                            },
                            "subject": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    }
                  },
                  "actions": {
                    "Response": {
                      "runAfter": {},
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": "@triggerBody()?['HTML']",
                        "statusCode": 200
                      }
                    }
                  },
                  "outputs": {}
                }
              }
            }
          ],
          "outputs": {
            "logicAppCallbackURL": {
              "type": "string",
              "value": "[listCallbackURL(format('{0}/triggers/manual', resourceId('Microsoft.Logic/workflows', parameters('logicAppName'))), '2019-05-01').value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "permissionsSqlDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "permissionsSqlDatabaseName": {
            "value": "[variables('permissionsSqlDatabaseName')]"
          },
          "permissionsSqlServerName": {
            "value": "[variables('permissionsSqlServerName')]"
          },
          "sqlAdministratorLogin": {
            "value": "[parameters('sqlAdministratorLogin')]"
          },
          "sqlAdministratorLoginPassword": {
            "value": "[parameters('sqlAdministratorLoginPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "3355312045463879661"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "permissionsSqlServerName": {
              "type": "string",
              "metadata": {
                "description": "The Permissions SQL Server name."
              }
            },
            "permissionsSqlDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "The Permissions SQL Database name."
              }
            },
            "sqlAdministratorLogin": {
              "type": "string",
              "metadata": {
                "description": "The SQL Server administrator login."
              }
            },
            "sqlAdministratorLoginPassword": {
              "type": "secureString",
              "metadata": {
                "description": "The SQL Server administrator login password."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2021-02-01-preview",
              "name": "[parameters('permissionsSqlServerName')]",
              "location": "[parameters('location')]",
              "properties": {
                "administratorLogin": "[parameters('sqlAdministratorLogin')]",
                "administratorLoginPassword": "[parameters('sqlAdministratorLoginPassword')]",
                "version": "12.0"
              }
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2021-02-01-preview",
              "name": "[format('{0}/{1}', parameters('permissionsSqlServerName'), parameters('permissionsSqlDatabaseName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic",
                "tier": "Basic"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('permissionsSqlServerName'))]"
              ]
            }
          ],
          "outputs": {
            "permissionsSqlServerFQDN": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Sql/servers', parameters('permissionsSqlServerName'))).fullyQualifiedDomainName]"
            },
            "permissionsSqlDatabaseConnectionString": {
              "type": "string",
              "value": "[format('Data Source=tcp:{0},1433;Initial Catalog={1};User Id={2}@{3};Password={4};', reference(resourceId('Microsoft.Sql/servers', parameters('permissionsSqlServerName'))).fullyQualifiedDomainName, parameters('permissionsSqlDatabaseName'), parameters('sqlAdministratorLogin'), reference(resourceId('Microsoft.Sql/servers', parameters('permissionsSqlServerName'))).fullyQualifiedDomainName, parameters('sqlAdministratorLoginPassword'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "adminSqlDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminSqlDatabaseName": {
            "value": "[variables('adminSqlDatabaseName')]"
          },
          "adminSqlServerName": {
            "value": "[variables('adminSqlServerName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sqlAdministratorLogin": {
            "value": "[parameters('sqlAdministratorLogin')]"
          },
          "sqlAdministratorLoginPassword": {
            "value": "[parameters('sqlAdministratorLoginPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "13949023618497482524"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "sqlAdministratorLogin": {
              "type": "string",
              "metadata": {
                "description": "The SQL Server administrator login."
              }
            },
            "sqlAdministratorLoginPassword": {
              "type": "secureString",
              "metadata": {
                "description": "The SQL Server administrator login password."
              }
            },
            "adminSqlServerName": {
              "type": "string",
              "metadata": {
                "description": "The Admin SQL Server name."
              }
            },
            "adminSqlDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "The Admin SQL Database name."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2021-02-01-preview",
              "name": "[parameters('adminSqlServerName')]",
              "location": "[parameters('location')]",
              "properties": {
                "administratorLogin": "[parameters('sqlAdministratorLogin')]",
                "administratorLoginPassword": "[parameters('sqlAdministratorLoginPassword')]",
                "version": "12.0"
              }
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2021-02-01-preview",
              "name": "[format('{0}/{1}', parameters('adminSqlServerName'), parameters('adminSqlDatabaseName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic",
                "tier": "Basic"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('adminSqlServerName'))]"
              ]
            }
          ],
          "outputs": {
            "adminSqlServerFQDN": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Sql/servers', parameters('adminSqlServerName'))).fullyQualifiedDomainName]"
            },
            "adminSqlDatabaseConnectionString": {
              "type": "string",
              "value": "[format('Data Source=tcp:{0},1433;Initial Catalog={1};User Id={2}@{3};Password={4};', reference(resourceId('Microsoft.Sql/servers', parameters('adminSqlServerName'))).fullyQualifiedDomainName, parameters('adminSqlDatabaseName'), parameters('sqlAdministratorLogin'), reference(resourceId('Microsoft.Sql/servers', parameters('adminSqlServerName'))).fullyQualifiedDomainName, parameters('sqlAdministratorLoginPassword'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "keyVaultDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminSqlConnectionStringSecretValue": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'adminSqlDeployment')).outputs.adminSqlDatabaseConnectionString.value]"
          },
          "azureAdB2cAdminApiClientIdSecretValue": {
            "value": "[parameters('azureAdB2cAdminApiClientIdSecretValue')]"
          },
          "azureAdB2cDomainSecretValue": {
            "value": "[parameters('azureAdB2cDomainSecretValue')]"
          },
          "azureAdB2cInstanceSecretValue": {
            "value": "[parameters('azureAdB2cInstanceSecretValue')]"
          },
          "azureAdB2cSignupAdminClientIdSecretValue": {
            "value": "[parameters('azureAdB2cSignupAdminClientIdSecretValue')]"
          },
          "azureAdB2cSignupAdminClientSecretSecretValue": {
            "value": "[parameters('azureAdB2cSignupAdminClientSecretSecretValue')]"
          },
          "azureAdB2cTenantIdSecretValue": {
            "value": "[parameters('azureAdB2cTenantIdSecretValue')]"
          },
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "permissionsApiCertificateSecretValue": {
            "value": "[parameters('permissionsApiCertificateSecretValue')]"
          },
          "permissionsApiSslThumbprintSecretValue": {
            "value": "[parameters('permissionsApiSslThumbprintSecretValue')]"
          },
          "permissionsSqlConnectionStringSecretValue": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'permissionsSqlDeployment')).outputs.permissionsSqlDatabaseConnectionString.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "17607114147143927277"
            }
          },
          "parameters": {
            "adminSqlConnectionStringSecretName": {
              "type": "string",
              "defaultValue": "ConnectionStrings--TenantsContext",
              "metadata": {
                "description": "The name of the Admin SQL Connection String Key Vault Secret."
              }
            },
            "adminSqlConnectionStringSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Admin SQL Connection String Key Vault Secret."
              }
            },
            "azureAdB2cAdminApiClientIdSecretName": {
              "type": "string",
              "defaultValue": "AzureAdB2C--ClientId",
              "metadata": {
                "description": "The name of the Azure AD B2C Admin Api Client Id Key Vault Secret."
              }
            },
            "azureAdB2cAdminApiClientIdSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Azure AD B2C Admin Api Client Id Key Vault Secret."
              }
            },
            "azureAdB2cDomainSecretName": {
              "type": "string",
              "defaultValue": "AzureAdB2C--Domain",
              "metadata": {
                "description": "The name of the Azure AD B2C Domain Key Vault Secret."
              }
            },
            "azureAdB2cDomainSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Azure AD B2C Domain Key Vault Secret."
              }
            },
            "azureAdB2cInstanceSecretName": {
              "type": "string",
              "defaultValue": "AzureAdB2C--Instance",
              "metadata": {
                "description": "The name of the Azure AD B2C Instance Key Vault Secret."
              }
            },
            "azureAdB2cInstanceSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Azure AD B2C Instance Key Vault Secret."
              }
            },
            "azureAdB2cSignupAdminClientIdSecretName": {
              "type": "string",
              "defaultValue": "AzureAdB2C--ClientId",
              "metadata": {
                "description": "The name of the Azure AD B2C Signup Admin Client Id Key Vault Secret."
              }
            },
            "azureAdB2cSignupAdminClientIdSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Azure AD B2C Signup Admin Client Id Key Vault Secret."
              }
            },
            "azureAdB2cSignupAdminClientSecretSecretName": {
              "type": "string",
              "defaultValue": "AzureAdB2C--ClientId",
              "metadata": {
                "description": "The name of the Azure AD B2C Signup Admin Client Secret Key Vault Secret."
              }
            },
            "azureAdB2cSignupAdminClientSecretSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Azure AD B2C Signup Admin Client Secret Key Vault Secret."
              }
            },
            "azureAdB2cTenantIdSecretName": {
              "type": "string",
              "defaultValue": "AzureAdB2C--Domain",
              "metadata": {
                "description": "The name of the Azure AD B2C Tenant Id Key Vault Secret."
              }
            },
            "azureAdB2cTenantIdSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Azure AD B2C Tenant Id Key Vault Secret."
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "permissionsApiCertificateSecretName": {
              "type": "string",
              "defaultValue": "KeyVault--PermissionsApiCertName",
              "metadata": {
                "description": "The name of the Permissions Api Certificate Key Vault Secret."
              }
            },
            "permissionsApiCertificateSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Permissions Api Certificate Key Vault Secret."
              }
            },
            "permissionsApiSslThumbprintSecretName": {
              "type": "string",
              "defaultValue": "AppSettings--SSLCertThumbprint",
              "metadata": {
                "description": "The name of the Permissions Api SSL Thumbprint Key Vault Secret."
              }
            },
            "permissionsApiSslThumbprintSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Permissions Api SSL Thumbprint Key Vault Secret."
              }
            },
            "permissionsSqlConnectionStringSecretName": {
              "type": "string",
              "defaultValue": "ConnectionStrings--PermissionsContext",
              "metadata": {
                "description": "The name of the Permissions SQL Connection String Key Vault Secret."
              }
            },
            "permissionsSqlConnectionStringSecretValue": {
              "type": "string",
              "metadata": {
                "description": "The value of the Permissions SQL Connection String Key Vault Secret."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2021-11-01-preview",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "standard",
                  "family": "A"
                },
                "enabledForTemplateDeployment": true,
                "enableSoftDelete": false,
                "enablePurgeProtection": false,
                "tenantId": "[subscription().tenantId]",
                "publicNetworkAccess": "enabled",
                "accessPolicies": []
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('permissionsApiSslThumbprintSecretName'))]",
              "properties": {
                "value": "[parameters('permissionsApiSslThumbprintSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('permissionsSqlConnectionStringSecretName'))]",
              "properties": {
                "value": "[parameters('permissionsSqlConnectionStringSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('permissionsApiCertificateSecretName'))]",
              "properties": {
                "value": "[parameters('permissionsApiCertificateSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('azureAdB2cInstanceSecretName'))]",
              "properties": {
                "value": "[parameters('azureAdB2cInstanceSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('azureAdB2cDomainSecretName'))]",
              "properties": {
                "value": "[parameters('azureAdB2cDomainSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('azureAdB2cAdminApiClientIdSecretName'))]",
              "properties": {
                "value": "[parameters('azureAdB2cAdminApiClientIdSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('azureAdB2cTenantIdSecretName'))]",
              "properties": {
                "value": "[parameters('azureAdB2cTenantIdSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('adminSqlConnectionStringSecretName'))]",
              "properties": {
                "value": "[parameters('adminSqlConnectionStringSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('azureAdB2cSignupAdminClientIdSecretName'))]",
              "properties": {
                "value": "[parameters('azureAdB2cSignupAdminClientIdSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('azureAdB2cSignupAdminClientSecretSecretName'))]",
              "properties": {
                "value": "[parameters('azureAdB2cSignupAdminClientSecretSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))).vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'adminSqlDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'permissionsSqlDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "permissionsApiDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')).outputs.appServicePlanId.value]"
          },
          "keyVaultUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment')).outputs.keyVaultUri.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "permissionsApiName": {
            "value": "[variables('permissionsApiName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "16801459570430797285"
            }
          },
          "parameters": {
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "The App Service Plan ID."
              }
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "The Uri of the Key Vault."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "permissionsApiName": {
              "type": "string",
              "metadata": {
                "description": "The Permissions Api name."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[parameters('permissionsApiName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "clientCertMode": "Optional",
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|6.0",
                  "appSettings": [
                    {
                      "name": "KeyVault__Url",
                      "value": "[parameters('keyVaultUri')]"
                    },
                    {
                      "name": "AllowedHosts",
                      "value": "*"
                    },
                    {
                      "name": "Logging__LogLevel__Default",
                      "value": "Information"
                    },
                    {
                      "name": "Logging__LogLevel__Microsoft.AspNetCore",
                      "value": "Warning"
                    }
                  ]
                }
              },
              "identity": {
                "type": "SystemAssigned"
              }
            }
          ],
          "outputs": {
            "permissionsApiHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('permissionsApiName'))).defaultHostName]"
            },
            "systemAssignedManagedIdentityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('permissionsApiName')), '2021-03-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "adminApiDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminApiName": {
            "value": "[variables('adminApiName')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')).outputs.appServicePlanId.value]"
          },
          "keyVaultUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment')).outputs.keyVaultUri.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "permissionsApiHostName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'permissionsApiDeployment')).outputs.permissionsApiHostName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "11581421794036148661"
            }
          },
          "parameters": {
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "The App Service Plan ID."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "adminApiName": {
              "type": "string",
              "metadata": {
                "description": "The Admin Api name."
              }
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "The Uri of the Key Vault."
              }
            },
            "permissionsApiCertificateSecretName": {
              "type": "string",
              "defaultValue": "KeyVault--PermissionsApiCertName",
              "metadata": {
                "description": "The name of the Permissions Api Certificate Key Vault Secret."
              }
            },
            "permissionsApiHostName": {
              "type": "string",
              "metadata": {
                "description": "The Permissions Api host name."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[parameters('adminApiName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|6.0",
                  "appSettings": [
                    {
                      "name": "AzureAdB2C__SignedOutCallbackPath",
                      "value": "/signout/B2C_1A_SIGNUP_SIGNIN"
                    },
                    {
                      "name": "AzureAdB2C:SignUpSignInPolicyId",
                      "value": "B2C_1A_SIGNUP_SIGNIN"
                    },
                    {
                      "name": "KeyVault__Url",
                      "value": "[parameters('keyVaultUri')]"
                    },
                    {
                      "name": "KeyVault__PermissionsApiCertName",
                      "value": "[parameters('permissionsApiCertificateSecretName')]"
                    },
                    {
                      "name": "PermissionsApi__BaseUrl",
                      "value": "[parameters('permissionsApiHostName')]"
                    },
                    {
                      "name": "AllowedHosts",
                      "value": "*"
                    },
                    {
                      "name": "Logging__LogLevel__Default",
                      "value": "Information"
                    },
                    {
                      "name": "Logging__LogLevel__Microsoft.AspNetCore",
                      "value": "Warning"
                    }
                  ]
                }
              },
              "identity": {
                "type": "SystemAssigned"
              }
            }
          ],
          "outputs": {
            "adminApiHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('adminApiName'))).defaultHostName]"
            },
            "systemAssignedManagedIdentityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('adminApiName')), '2021-03-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'permissionsApiDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "signupAdminAppServiceDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminApiHostName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'adminApiDeployment')).outputs.adminApiHostName.value]"
          },
          "adminApiScopes": {
            "value": "[parameters('adminApiScopes')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')).outputs.appServicePlanId.value]"
          },
          "keyVaultUri": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment')).outputs.keyVaultUri.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "signupAdminAppServiceName": {
            "value": "[variables('signupAdminAppServiceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "11473093136894240647"
            }
          },
          "parameters": {
            "adminApiHostName": {
              "type": "string",
              "metadata": {
                "description": "The Admin Api host name."
              }
            },
            "adminApiScopes": {
              "type": "string",
              "metadata": {
                "description": "Scopes to authorize user for the admin service."
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "The App Service Plan ID."
              }
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "The Uri of the Key Vault."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "signupAdminAppServiceName": {
              "type": "string",
              "metadata": {
                "description": "The Signup Admin App Service name."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[parameters('signupAdminAppServiceName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|6.0",
                  "appSettings": [
                    {
                      "name": "AppSettings__AdminServiceBaseUrl",
                      "value": "[parameters('adminApiHostName')]"
                    },
                    {
                      "name": "AppSettings__AdminServiceScopes",
                      "value": "[parameters('adminApiScopes')]"
                    },
                    {
                      "name": "AzureAdB2C__SignedOutCallbackPath",
                      "value": "/signout/B2C_1A_SIGNUP_SIGNIN"
                    },
                    {
                      "name": "AzureAdB2C:SignUpSignInPolicyId",
                      "value": "B2C_1A_SIGNUP_SIGNIN"
                    },
                    {
                      "name": "KeyVault__Url",
                      "value": "[parameters('keyVaultUri')]"
                    },
                    {
                      "name": "AllowedHosts",
                      "value": "*"
                    },
                    {
                      "name": "Logging__LogLevel__Default",
                      "value": "Information"
                    },
                    {
                      "name": "Logging__LogLevel__Microsoft.AspNetCore",
                      "value": "Warning"
                    }
                  ]
                }
              },
              "identity": {
                "type": "SystemAssigned"
              }
            }
          ],
          "outputs": {
            "signupAdminAppServiceHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('signupAdminAppServiceName'))).defaultHostName]"
            },
            "systemAssignedManagedIdentityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('signupAdminAppServiceName')), '2021-03-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'adminApiDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "applicationAppServiceDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "applicationAppServiceName": {
            "value": "[variables('applicationAppServiceName')]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')).outputs.appServicePlanId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "7804205243908076312"
            }
          },
          "parameters": {
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "The App Service Plan ID."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for all resources."
              }
            },
            "applicationAppServiceName": {
              "type": "string",
              "metadata": {
                "description": "The Application App Service name."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[parameters('applicationAppServiceName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|6.0",
                  "appSettings": []
                }
              }
            }
          ],
          "outputs": {
            "applicationAppServiceHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('applicationAppServiceName'))).defaultHostName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "keyVaultAccessPolicyDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminApiPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'adminApiDeployment')).outputs.systemAssignedManagedIdentityPrincipalId.value]"
          },
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "permissionApiPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'permissionsApiDeployment')).outputs.systemAssignedManagedIdentityPrincipalId.value]"
          },
          "signupAdminAppServicePrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'signupAdminAppServiceDeployment')).outputs.systemAssignedManagedIdentityPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "15743699118325103784"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault."
              }
            },
            "adminApiPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The Principal Id of the Admin Api System Assigned Managed Identity."
              }
            },
            "permissionApiPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The Principal Id of the Permissions Api System Assigned Managed Identity."
              }
            },
            "signupAdminAppServicePrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The Principal Id of the Signup Admin App Service System Assigned Managed Identity."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
              "properties": {
                "accessPolicies": [
                  {
                    "objectId": "[parameters('adminApiPrincipalId')]",
                    "tenantId": "[subscription().tenantId]",
                    "permissions": {
                      "secrets": [
                        "get"
                      ]
                    }
                  },
                  {
                    "objectId": "[parameters('permissionApiPrincipalId')]",
                    "tenantId": "[subscription().tenantId]",
                    "permissions": {
                      "secrets": [
                        "get"
                      ]
                    }
                  },
                  {
                    "objectId": "[parameters('signupAdminAppServicePrincipalId')]",
                    "tenantId": "[subscription().tenantId]",
                    "permissions": {
                      "secrets": [
                        "get"
                      ]
                    }
                  }
                ]
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'adminApiDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'permissionsApiDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'signupAdminAppServiceDeployment')]"
      ]
    }
  ]
}